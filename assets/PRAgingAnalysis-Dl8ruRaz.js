import{j as a,r as j,k as w,m as O,e as I,l as M,i as S,n as k}from"../index.f7nfUctD.js";import{S as B,g as $,T,p as q,P as E}from"./pr-analysis-rlmRD_X1.js";import{C as A,S as v,a as L,b as U,c as _,u as z,g as F,P as G}from"./chart-options-mACXGUK2.js";function H({data:i,options:y,metrics:h,isLoading:c}){const{averagePRAge:f,contributorCount:m,maxPRAge:d,totalPRCount:x}=h||{};return a.jsxs("div",{className:"bg-white shadow-lg rounded-md px-4 pt-4 flex flex-col flex-1 w-full",children:[a.jsx("div",{className:"flex justify-between items-center mb-4",children:a.jsx("h3",{className:"text-lg font-extrabold text-gray-600",children:"Open Pull Requests"})}),a.jsxs("div",{className:"flex flex-col md:flex-row justify-around mb-3 w-full",children:[a.jsx(A,{isLoading:c,total:f,label:"Avg. Age",icon:v,iconProps:{fill:"#00c951"},textClassName:"text-green-700"}),a.jsx(A,{isLoading:c,total:d,label:"Max Age",icon:v,iconProps:{fill:"#00c951"},textClassName:"text-green-700"}),a.jsx(A,{isLoading:c,total:x,label:"Total Count",icon:B,iconProps:{fill:"#00c951"},textClassName:"text-green-700"}),a.jsx(A,{isLoading:c,total:m,label:"Contributors",icon:L,iconProps:{fill:"#00c951"},textClassName:"text-green-700"})]}),a.jsxs("div",{className:"w-full flex-1",children:[c&&a.jsx("div",{className:"pb-4 h-88",children:a.jsx(U,{count:15,order:"desc",legendsCount:4})}),!c&&!!i&&a.jsx(_,{data:i,options:y,type:"bar",width:"100%",height:370})]})]})}function W(){const{current:i,isLoading:y}=z(),h=(i==null?void 0:i.prList)||[],{openPRs:c,metrics:f,prDetails:m}=j.useMemo(()=>{const r=h.filter(e=>e.state==="OPEN"),u=$(r),b=w(u,e=>e.exactDaysOpen),P=O(u,e=>e.exactDaysOpen),t=I(u,e=>e.exactDaysOpen),n=M(r,e=>{var o,s;return(s=(o=e.author)==null?void 0:o.user)==null?void 0:s.name}),l={totalPRCount:r.length,contributorCount:n,averagePRAge:t,maxPRAge:P,minPRAge:b};return{openPRs:r,metrics:l,prDetails:S(u,e=>e.exactDaysOpen)}},[h]),{sortedPRs:d,bins:x}=j.useMemo(()=>{const r=m.slice(0,20),u=r.length,b=u>=2?3:1,P=Math.ceil(u/b),t=[];for(let l=0;l<b;l++){const e=l*P,o=Math.min((l+1)*P,u),s=r.slice(e,o);if(s.length===0)continue;const p=Math.ceil(s[0].exactDaysOpen),g=Math.floor(s[s.length-1].exactDaysOpen),D=p===g?`${p} day${p===1?"":"s"}`:`${g} to ${p} days`;t.push({label:D,min:g,max:p,color:""});for(let C=e;C<o;C++)r[C].binIndex=t.length-1}const n=t.length;return t.forEach((l,e)=>{const o=Math.round(e/(n>1?n-1:1)*120);l.color=`hsl(${o}, 70%, 50%)`}),{sortedPRs:r,bins:t}},[c]),R=j.useMemo(()=>{const r=d.map(t=>{var n;return(n=t.pr.author)==null?void 0:n.user}),u=r.map(t=>(t==null?void 0:t.displayName)||(t==null?void 0:t.name)||"Unknown"),b={label:"PR Age",originalData:d.map(t=>t.daysOpen),backgroundColor:d.map(t=>{var l;const n=t.binIndex;return((l=x[n])==null?void 0:l.color)||"gray"}),data:d.map(t=>t.daysOpen),prDetails:d.map(t=>t.pr),hiddenBins:Array(x.length).fill(!1)},P={...F(),plugins:{tooltip:{callbacks:{label:t=>{var o,s,p,g;const n=t.dataset,l=t.dataIndex,e=n.prDetails&&n.prDetails[l];if(e){const D=((s=(o=e.author)==null?void 0:o.user)==null?void 0:s.displayName)||((g=(p=e.author)==null?void 0:p.user)==null?void 0:g.name)||"Unknown",C=e.title||"",N=k(e.createdDate).toLocaleDateString();return[`Author: ${D}`,`Title: ${C}`,`Created: ${N}`,`Age: ${t.parsed.y} days`]}return""}}},legend:{labels:{generateLabels:t=>x.map((n,l)=>({text:n.label,fillStyle:n.color,binIndex:l,datasetIndex:0}))},onClick:(t,n,l)=>{const e=n.binIndex,o=l.chart,s=o.data.datasets[0];s.hiddenBins=s.hiddenBins||Array(x.length).fill(!1),s.hiddenBins[e]=!s.hiddenBins[e],s.data=s.originalData.map((p,g)=>d[g].binIndex===e&&s.hiddenBins[e]?null:p),o.update()}}},scales:{x:{ticks:{display:!1},afterFit:t=>t.height=50},y:{beginAtZero:!0,title:{display:!1,text:"PR Age (days)"}}},users:r};return{data:{labels:u,datasets:[b]},options:P}},[d,x]);return{data:R.data,options:R.options,isLoading:y,metrics:f,prDetails:m}}const Z=q.filter(i=>i.field!=="state"&&i.field!=="closed");function V(){const{data:i,options:y,metrics:h,isLoading:c,prDetails:f}=W(),[m,d]=j.useState(null),x=({row:R})=>d(R);return a.jsxs("div",{children:[a.jsx(G,{title:"Pull Request Aging"}),a.jsxs("div",{className:"flex flex-col gap-4",children:[a.jsx(H,{data:i,options:y,metrics:h,isLoading:c}),a.jsx(T,{isLoading:c,containerClassName:"max-h-[80vh]",columns:Z,rows:f,noRowsMessage:"No data found",totalRows:f.length,pagination:!1,onRowClick:x}),!!m&&a.jsx(E,{className:"mt-6",pr:m.pr,url:m.url})]})]})}export{V as default};
