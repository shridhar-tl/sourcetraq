var S=Object.defineProperty;var F=(e,s,l)=>s in e?S(e,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[s]=l;var R=(e,s,l)=>F(e,typeof s!="symbol"?s+"":s,l);import{r as f,j as t,c as h,i as N,L as W,d as O,h as B,s as I,e as P,k as z,u as q,l as M,m as $,n as k,o as H,R as U}from"../index.BzN25hFh.js";import{t as A,u as E,f as _,P as G}from"./chart-options-DtC3Yyrp.js";import{P as V,R as K,a as J,b as Q}from"./ReviewerStatsChart-CfwtXC_d.js";import{P as X,p as Y,e as Z,a as ee,T as te}from"./PRActivityDetails-C7OnPG1V.js";import{I as T}from"./Image-BsNB1ju6.js";import{c as se}from"./chart-helpers-B6cvJ9Rg.js";const re=e=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"{2} ",stroke:"currentColor",className:"size-4",...e},f.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.5 12h-15"})),ae=e=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"{2} ",stroke:"currentColor",...e},f.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"}));function le({height:e,tabs:s,className:l}){const[o,u]=f.useState(window.innerWidth),[a,c]=f.useState(s.map(i=>i.isOpen));f.useEffect(()=>{const i=()=>u(window.innerWidth);return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]);const n=f.useCallback(i=>{a.filter(Boolean).length===1&&a[i]||c(m=>m.map((p,w)=>w===i?!p:p))},[a]),r=a.filter(Boolean).length,x=i=>({maxWidth:i&&o>=1024?ne(r,a,s.length):void 0});return t.jsx("div",{className:h("flex flex-col lg:flex-row w-full h-full max-w-full",l),style:{minHeight:`${e}px`},children:s.map((i,d)=>{const m=a[d],p=x(m);return t.jsxs("div",{id:i.id,style:p,className:h("relative transition-all duration-300 bg-white dark:bg-gray-600",{"flex-grow border-white":m,"flex-none w-full lg:w-10 hover:bg-[#ecf2f8] dark:hover:bg-gray-500 px-2 lg:px-0 border border-gray-200 dark:border-gray-900":!m,"mt-3 ms-0 lg:mt-0 lg:ms-3":d>0&&m&&a[d-1],"mt-2 lg:mt-0":!m&&d>0&&a[d-1],"mb-2 lg:mb-0":!m&&a[d+1]}),children:[!m&&t.jsxs("div",{className:"flex lg:flex-col w-full lg:w-auto lg:h-full inset-0 cursor-pointer py-2",onClick:()=>n(d),children:[t.jsx("div",{children:t.jsx(ae,{className:"size-5 mx-auto mb-1 dark:text-white"})}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsx("span",{className:"text-base lg:transform lg:-rotate-90 whitespace-nowrap text-center dark:text-gray-200",children:i.label})})]}),m&&t.jsxs(t.Fragment,{children:[r>1&&t.jsx("div",{className:"absolute -top-3 right-2 cursor-pointer z-10",onClick:()=>n(d),children:t.jsx("div",{className:"bg-[#f1f5f9] dark:bg-gray-600 hover:bg-[#e2ecf7] dark:hover:bg-gray-500 rounded-full p-1 shadow",children:t.jsx(re,{className:"size-4 dark:text-white"})})}),t.jsx("div",{className:h("h-full overflow-hidden dark:text-gray-200",{"bg-white dark:bg-gray-900 shadow-lg":!N,"bg-[#fdfdfd]":N}),children:i.render({index:d,isOpen:m,totalOpen:r,maxWidth:p.maxWidth})})]})]},i.id||d)})})}function ne(e,s,l){const o=12*s.reduce((c,n,r)=>n&&r&&s[r-1]?c+1:0,0),u=parseFloat((((l-e)*40+o)/e).toFixed(2));return`calc(${parseFloat((100/e).toFixed(2))}% - ${u}px)`}class ie{constructor(s){R(this,"tasks",[]);R(this,"currentCount",0);this.maxConcurrency=s}async acquire(){return this.currentCount<this.maxConcurrency?(this.currentCount++,this.release.bind(this)):new Promise(s=>{this.tasks.push(()=>{this.currentCount++,s(this.release.bind(this))})})}release(){if(this.currentCount--,this.tasks.length>0){const s=this.tasks.shift();s&&s()}}}const oe=({item:e,fetchActivity:s,maxDays:l,activityColors:o,statusColor:u,tooltipRenderer:a,semaphore:c,onItemClick:n})=>{var p,w,j;const r=f.useRef(null),[x,i]=f.useState(null),d=A(100/e.days)+"%";f.useEffect(()=>{if(x)return;const g=new IntersectionObserver(v=>{v.forEach(async y=>{if(y.isIntersecting&&!x){const b=await c.acquire();try{const C=await s(e);i(C),r.current&&g.observe(r.current)}finally{b()}}})},{rootMargin:"100px"});return r.current&&g.observe(r.current),()=>{r.current&&g.unobserve(r.current)}},[x,s,e.id,c]);const m=Array.from({length:e.days});return t.jsxs("div",{ref:r,className:"flex items-center justify-between border-b border-gray-200 h-19 py-1 ps-2 gap-2",children:[t.jsxs("div",{className:h("w-10 min-w-10",{"flex flex-col h-full justify-around":!!e.flagColor,"h-10":!e.flagColor}),children:[t.jsx(T,{src:e.user.avatar,displayName:e.user.displayName,className:"rounded-full"}),!!e.flagColor&&t.jsx("div",{className:"w-full h-3 rounded",style:{backgroundColor:e.flagColor},title:e.flagMessage})]}),t.jsxs("div",{className:"flex flex-1 flex-col gap-2 cursor-pointer max-w-[calc(100%-50px)]",onClick:n?()=>n(e):void 0,children:[t.jsxs("div",{className:"flex items-center justify-between px-1 gap-2 w-full",children:[t.jsxs("div",{className:"flex-1 text-xs overflow-hidden truncate",children:[t.jsxs(W,{href:e.url,children:["#",e.id]})," - ",e.title]}),t.jsxs("div",{className:"flex-none flex items-center gap-2",children:[t.jsx("div",{className:"text-xs text-gray-500 whitespace-nowrap",children:O(e.startDate,e.endDate)}),t.jsxs("div",{className:"flex flex-grow gap-1",children:[(p=e.participants)==null?void 0:p.slice(0,3).map((g,v)=>t.jsx(T,{src:g.user.avatar,displayName:g.user.displayName,className:"rounded-full",size:"xs"},v)),((w=e.participants)==null?void 0:w.length)>3&&t.jsxs("div",{className:"flex flex-column items-center justify-center size-6 text-[11px] rounded-full bg-[#9cc8f3]",children:["+",((j=e.participants)==null?void 0:j.length)-3]})]}),t.jsx(X,{pr:e.pr,state:e.state})]})]}),t.jsx("div",{className:"flex bg-blue-300 border-r-5 border-r-blue-300 h-8 rounded-e-md",style:{width:`${Math.min(100,A(e.days*100/l))}%`,borderRightColor:u[e.state]},children:m.map((g,v)=>{const y=(x==null?void 0:x[v])||[];return t.jsx("div",{style:{width:d},className:"flex flex-col",onMouseEnter:a?b=>I(b,a(e,v,y)):void 0,onMouseLeave:a?()=>B():void 0,children:y!=null&&y.length?y.map((b,C)=>t.jsx("div",{className:"flex-1",style:{backgroundColor:o[b.type]||"#"+Math.floor(Math.random()*16777215).toString(16)}},C)):t.jsx("div",{className:"flex-1"})},v)})})]})]})},ce=24,de=({maxDays:e})=>{const s=f.useRef(null),[l,o]=f.useState(0);f.useEffect(()=>{if(!s.current)return;let n=null;const r=new window.ResizeObserver(x=>{x[0]&&(clearTimeout(n),n=setTimeout(()=>{o(x[0].contentRect.width)},350))});return r.observe(s.current),o(s.current.offsetWidth),()=>{r.disconnect(),clearTimeout(n)}},[]);const u=l-70,a=Math.max(1,Math.floor(u/ce)),c=Math.max(1,Math.ceil(e/a));return t.jsxs("div",{ref:s,className:"flex border-t border-gray-300 ps-2 pe-1.5 py-1 font-semibold text-xs w-full",children:[t.jsx("span",{className:"mr-3.5",children:"Days:"}),Array.from({length:e}).map((n,r)=>r!==0&&r%c!==0?t.jsx("div",{className:"flex-1"},r):t.jsx("div",{className:"flex-1",children:t.jsx("span",{className:"text-gray-600 dark:text-gray-300",children:r})},r)),t.jsx("div",{className:"flex-none pe-2",children:t.jsx("span",{className:"text-gray-600 dark:text-gray-300",children:e})})]})},ue=({height:e=400,items:s,fetchActivity:l,activityColors:o={},statusColor:u={},tooltipRenderer:a,semaphoreConcurrency:c=3,onItemClick:n})=>{const r=f.useMemo(()=>Math.floor(s.reduce((i,d)=>Math.max(i,d.days),0)),[s]),x=f.useMemo(()=>new ie(c),[c]);return t.jsxs("div",{className:"w-full max-h-full",children:[t.jsx("div",{className:"flex flex-col overflow-y-auto overflow-x-hidden w-full",style:{height:e-23},children:s.map(i=>t.jsx(oe,{item:i,fetchActivity:l,maxDays:r,activityColors:o,statusColor:u,tooltipRenderer:a,semaphore:x,onItemClick:n},i.id))}),t.jsx(de,{maxDays:r})]})};function me(){const{current:e,isLoading:s}=E(),l=(e==null?void 0:e.prList)||[],o=new Date,u=P(l.map(a=>{var g,v,y;const{id:c,closedDate:n,createdDate:r,reviewers:x,state:i,title:d,author:{user:m}={},description:p}=a,w=z(n||o,r),j=P(x.map(b=>({user:b.user,done:b.approved})),b=>b.done?1:0);if(!(w<1&&(i==="OPEN"||i==="MERGED")))return{id:c,user:m,participants:j,flagColor:Z(p),flagMessage:Y,title:d,state:i,pr:a,startDate:r,endDate:n,days:w,url:(y=(v=(g=a.links)==null?void 0:g.self)==null?void 0:v[0])==null?void 0:y.href}}).filter(Boolean),a=>a.days);return{isLoading:s,prDetails:u}}const L={APPROVED:"#28a745",RESCOPED:"#f3ae2f",COMMENTED:"#6666f1",MERGED:"purple",OTHERS:"gray",UNAPPROVED:"#f56f76"},fe={MERGED:"#00c951",DECLINED:"#fb2c36"},xe=(e,s,l)=>t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("div",{className:"truncate",children:t.jsxs("strong",{children:["#",e.id," - ",e.title]})}),t.jsxs("strong",{children:["Day ",s+1," Activities:"]}),t.jsx("div",{children:l!=null&&l.length?l.map(o=>`${o.type}: ${o.count}`).join(", "):"(Idle)"})]});function he(e,s){const l=s.createdDate;return k(e,o=>H(o.createdDate,l)).reduce((o,u)=>(o[u.key]=k(u.values,a=>L[a.action]?a.action:"OTHERS").map(a=>({type:a.key,count:a.values.length,raw:a.values})),o),{})}function pe(){const{isLoading:e,prDetails:s}=me(),[l,o]=q(_(c=>{var n,r;return[(n=c.project)==null?void 0:n.key,(r=c.repository)==null?void 0:r.slug]})),u=c=>M(t.jsx(ee,{pr:c.pr,url:c.url}),{occupy:!0}),a=async c=>{const n=c.pr;if(!n.activities){const{$repository:r}=$("RepositoryService");n.activities=await r.getPullRequestActivity(l,o,c.id)}return he(n.activities,n)};return t.jsxs("div",{className:h("rounded-md pt-4 flex flex-col w-full",{"bg-white dark:bg-gray-900 shadow-lg":!N,"bg-[#fdfdfd]":N}),children:[t.jsxs("div",{className:"flex flex-wrap justify-between items-center mb-4 px-4 gap-3",children:[t.jsx("h3",{className:"whitespace-nowrap text-lg font-extrabold text-gray-600 dark:text-gray-200",children:"Day wise Activities"}),t.jsxs("div",{className:"flex flex-nowrap gap-2 text-[11px]",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[#28a745] inline-block mr-1"})," Approved"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[#6666f1] inline-block mr-1"})," Comment"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[#f3ae2f] inline-block mr-1"})," Commit"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[purple] inline-block mr-1"})," Merge"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[gray] inline-block mr-1"})," Others"]})]})]}),t.jsx(ue,{isLoading:e,height:457,items:s,fetchActivity:a,activityColors:L,statusColor:fe,tooltipRenderer:xe,semaphoreConcurrency:3,onItemClick:u})]})}function ge({field:e,className:s,onChange:l,...o}){const u=U.useCallback(a=>l==null?void 0:l(a.target.value,e),[e,l]);return t.jsx("input",{className:h("px-2 h-9 bg-white dark:bg-gray-900 dark:text-gray-200 border dark:placeholder:text-gray-200 border-gray-200 rounded",s),...o,onChange:u})}function ve(e){const{current:s,previous:l,isLoading:o,settings:u}=E(),a=s==null?void 0:s.contributions,c=l==null?void 0:l.contributions,n=f.useMemo(()=>se(a,c),[a,c]),r=(e==null?void 0:e.toLowerCase())||"",x=f.useMemo(()=>r?n.filter(i=>{const{displayName:d,name:m,emailAddress:p}=i.user;return(d==null?void 0:d.toLowerCase().includes(r))||(m==null?void 0:m.toLowerCase().includes(r))||(p==null?void 0:p.toLowerCase().includes(r))}):n,[n,r]);return{isLoading:o,analytics:x,settings:u}}const D=[{field:"user.displayName",title:"Author Name",template:e=>{var s,l;return((s=e.user)==null?void 0:s.displayName)||((l=e.user)==null?void 0:l.name)},headerClassName:h("text-left")},{field:"user.emailAddress",title:"Email",hideBelow:"3xl",cellClassName:h("border-e border-gray-300"),headerClassName:h("border-e border-gray-300 text-left")},{field:"totalCommits",sortable:!0,title:"Total Commits",helpText:"Total number of commits by the user during this period",cellClassName:h("border-e border-gray-300 text-center"),headerClassName:h("border-e border-gray-300 text-center"),hideBelow:"2xl",template:e=>t.jsxs(t.Fragment,{children:[e.totalCommits," ",t.jsxs("span",{className:h("text-sm",{"text-green-600":e.commitDelta.diff>0,"text-red-600":e.commitDelta.diff<0}),children:["(",e.commitDelta.diff>=0?"+":"",e.commitDelta.diff," / ",e.commitDelta.percent,"%)"]})]})},{field:"totalPRs",sortable:!0,title:"PRs",helpText:"Total number of PR's raised by the user during this period",cellClassName:"text-center",headerClassName:"text-center",template:e=>t.jsxs(t.Fragment,{children:[e.totalPRs,t.jsxs("span",{className:h("text-sm ps-1.5 hidden xl:inline-block",{"text-green-600":e.prDelta.diff>0,"text-red-600":e.prDelta.diff<0}),children:["(",e.prDelta.diff>=0?"+":"",e.prDelta.diff," / ",e.prDelta.percent,"%)"]})]})},{field:"mergedPRs",title:"Merged",sortable:!0,helpText:"Total number of PR's raised by the user during this period is merged as of now",cellClassName:"text-center",headerClassName:"text-center"},{field:"declinedPRs",sortable:!0,title:"Declined",helpText:"Total number of PR's raised by the user during this period is declined",cellClassName:"text-center",headerClassName:"text-center",template:e=>!!e.declinedPRs&&t.jsxs(t.Fragment,{children:[e.declinedPRs,t.jsxs("span",{className:h("text-sm ps-1.5 hidden xl:inline-block",{"text-green-600":e.declinedDelta.diff<0,"text-red-600":e.declinedDelta.diff>=0}),children:["(",e.declinedDelta.diff>=0?"+":"",!!e.declinedDelta.diff&&t.jsxs(t.Fragment,{children:[e.declinedDelta.diff," / ",e.declinedDelta.percent,"%)"]})]})]})},{field:"avgPROpenDays",sortable:!0,title:"Age",helpText:"Average number of days the PR was open before either it is merged or declined",cellClassName:"text-center",headerClassName:"text-center",template:e=>e.avgPROpenDays>.5?e.avgPROpenDays:""},{field:"avgDaysFirstCommitToPR",sortable:!0,title:"Lag",helpText:"Average number of days it took for the user to raise PR after the first commit was created",cellClassName:"text-center",headerClassName:"text-center",template:e=>e.avgDaysFirstCommitToPR>.5?e.avgDaysFirstCommitToPR:""},{field:"avgDaysPRToMerge",sortable:!0,title:"Merge",helpText:"Average number of days it took for the user to merge the PR",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgDaysPRToApproval",sortable:!0,title:"Approval Lag",helpText:"Average number of days it took to get the Approval",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgReviewers",sortable:!0,title:"Reviewers",helpText:"Average number of reviewers added to each PR",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgReviewersApproved",sortable:!0,title:"Approvals",helpText:"Average number of reviewers approving the PR",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgComments",sortable:!0,title:"Comments",helpText:"Average number of comments in the PR. This includes responses as well",cellClassName:"text-center",headerClassName:"text-center",template:e=>t.jsxs(t.Fragment,{children:[e.avgComments,(e.commentDelta.diff>=1||e.commentDelta.diff<=-1)&&t.jsxs("span",{className:h("text-sm ps-1.5 hidden xl:inline-block",{"text-green-600":e.commentDelta.diff<0,"text-red-600":e.commentDelta.diff>=0}),children:["(",e.commentDelta.diff>=0?"+":"",e.commentDelta.diff," / ",Math.round(e.commentDelta.percent),"%)"]})]})},{field:"avgDaysFirstActivity",sortable:!0,title:"Activity Lag",helpText:"Average number of days it took for first activity to happen in the PR.",cellClassName:"text-center",headerClassName:"text-center"}],ye={totalCommits:"includeCommits",avgDaysFirstCommitToPR:"includePRCommitMetrics",avgDaysFirstActivity:"includePRActivity",avgComments:"includePRActivity",avgDaysPRToApproval:"includePRActivity"},be=D.find(e=>e.field==="totalPRs");function we(){const[e,s]=f.useState(""),{isLoading:l,analytics:o,settings:u}=ve(e),a=({row:i})=>M(t.jsx(V,{username:i.user.name}),{occupy:!0}),{includeCommits:c,includePRCommitMetrics:n,includePRActivity:r}=u||{},x=f.useMemo(()=>{if(c&&n&&r)return D;const i={includeCommits:c,includePRCommitMetrics:n,includePRActivity:r};return D.filter(d=>{const m=ye[d.field];return m?i[m]!==!1:!0})},[c,n,r]);return t.jsxs("div",{className:"my-6",children:[t.jsxs("div",{className:"flex justify justify-between",children:[t.jsx("h3",{className:"text-base font-semibold mb-4",children:"Author Wise Metrics"}),t.jsx(ge,{placeholder:"Search for users",onChange:s,className:"w-50"})]}),t.jsx(te,{id:"userWisePRMetrics",isLoading:l,expectedRows:5,columns:x,rows:o,sortColumn:be,sortAsc:!1,noRowsMessage:"No data found",totalRows:o.length,pagination:!1,onRowClick:a})]})}const je=[{id:"resolution-time-distribution",label:"Resolution Time Distribution",isOpen:!1,render:({maxWidth:e,totalOpen:s})=>t.jsx(K,{maxWidth:e,totalOpen:s})},{id:"reviewer-stats-chart",label:"Reviewer Metrics",isOpen:!0,render:({maxWidth:e,totalOpen:s})=>t.jsx(J,{maxWidth:e,totalOpen:s})},{id:"pull-request-chart",label:"Pull Request Metrics",isOpen:!0,render:({maxWidth:e,totalOpen:s})=>t.jsx(Q,{maxWidth:e,totalOpen:s})},{id:"pull-request-cycle-time-chart",label:"Cycle Time Analysis",isOpen:!1,render:()=>t.jsx(pe,{})}];function Te(){return t.jsxs(t.Fragment,{children:[t.jsx(G,{title:"Pull Request Analysis"}),t.jsx(le,{tabs:je,height:520}),t.jsx(we,{})]})}export{Te as default};
