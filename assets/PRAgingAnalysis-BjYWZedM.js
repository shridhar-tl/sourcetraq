import{j as n,r as A,t as $,p as B,o as N,v as I,e as O,m as S,w as o,x as k}from"../index.qPuWtL5Z.js";import{S as q,g as T,T as E,b as L,a as U}from"./pr-analysis-DLT0ppzL.js";import{C as R,S as C,a as _,b as F,c as G,u as H,g as W,P as Z}from"./chart-options-BM9C3PSU.js";function z({data:r,options:f,metrics:p,isLoading:e}){const{averagePRAge:d,contributorCount:t,maxPRAge:c,totalPRCount:u}=p||{};return n.jsxs("div",{className:"bg-white shadow-lg rounded-md px-4 pt-4 flex flex-col flex-1 w-full",children:[n.jsx("div",{className:"flex justify-between items-center mb-4",children:n.jsx("h3",{className:"text-lg font-extrabold text-gray-600",children:"Open Pull Requests"})}),n.jsxs("div",{className:"flex flex-col md:flex-row justify-around mb-3 w-full",children:[n.jsx(R,{isLoading:e,total:d,label:"Avg. Age",icon:C,iconProps:{fill:"#00c951"},textClassName:"text-green-700"}),n.jsx(R,{isLoading:e,total:c,label:"Max Age",icon:C,iconProps:{fill:"#00c951"},textClassName:"text-green-700"}),n.jsx(R,{isLoading:e,total:u,label:"Total Count",icon:q,iconProps:{fill:"#00c951"},textClassName:"text-green-700"}),n.jsx(R,{isLoading:e,total:t,label:"Contributors",icon:_,iconProps:{fill:"#00c951"},textClassName:"text-green-700"})]}),n.jsxs("div",{className:"w-full flex-1",children:[e&&n.jsx("div",{className:"pb-4 h-88",children:n.jsx(F,{count:15,order:"desc",legendsCount:4})}),!e&&!!r&&n.jsx(G,{data:r,options:f,type:"bar",width:"100%",height:370})]})]})}function J(){const{current:r,isLoading:f}=H(),p=(r==null?void 0:r.prList)||[],{openPRs:e,metrics:d,prDetails:t}=A.useMemo(()=>{const i=p.filter(s=>s.state==="OPEN"),h=T(i),g=$(h,s=>s.exactDaysOpen),b=B(h,s=>s.exactDaysOpen),a=N(h,s=>s.exactDaysOpen),l=I(i,s=>{var v,m;return(m=(v=s.author)==null?void 0:v.user)==null?void 0:m.name}),x={totalPRCount:i.length,contributorCount:l,averagePRAge:a,maxPRAge:b,minPRAge:g};return{openPRs:i,metrics:x,prDetails:O(h,s=>s.exactDaysOpen)}},[p]),{sortedPRs:c,bins:u}=A.useMemo(()=>{if(!(t!=null&&t.length))return{sortedPRs:[],bins:[]};const i=t.slice(0,20),h=i.map(b=>b.exactDaysOpen),g=K(h).reverse();if(g.length){const b=g.length;g.forEach((a,l)=>{const x=Math.round(l/(b>1?b-1:1)*120);a.color=`hsl(${x}, 70%, 50%)`});for(const a of i)for(let l=0;l<g.length&&(a.binIndex=l,!(a.exactDaysOpen>=g[l].min));l++);}return{sortedPRs:i,bins:g}},[e]),y=A.useMemo(()=>{const i=c.map(a=>{var l;return(l=a.pr.author)==null?void 0:l.user}),h=i.map(a=>(a==null?void 0:a.displayName)||(a==null?void 0:a.name)||"Unknown"),g={label:"PR Age",originalData:c.map(a=>a.daysOpen),backgroundColor:c.map(a=>{var x;const l=a.binIndex;return((x=u[l])==null?void 0:x.color)||"gray"}),data:c.map(a=>a.daysOpen),prDetails:c.map(a=>a.pr),hiddenBins:Array(u.length).fill(!1)},b={...W(),plugins:{tooltip:{callbacks:{label:a=>{var v,m,M,P;const l=a.dataset,x=a.dataIndex,s=l.prDetails&&l.prDetails[x];if(s){const w=((m=(v=s.author)==null?void 0:v.user)==null?void 0:m.displayName)||((P=(M=s.author)==null?void 0:M.user)==null?void 0:P.name)||"Unknown",D=s.title||"",j=k(s.createdDate).toLocaleDateString();return[`Author: ${w}`,`Title: ${D}`,`Created: ${j}`,`Age: ${a.parsed.y} days`]}return""}}},legend:{labels:{generateLabels:a=>u.map((l,x)=>({text:l.label,fillStyle:l.color,binIndex:x,datasetIndex:0}))},onClick:(a,l,x)=>{const s=l.binIndex,v=x.chart,m=v.data.datasets[0];m.hiddenBins=m.hiddenBins||Array(u.length).fill(!1),m.hiddenBins[s]=!m.hiddenBins[s],m.data=m.originalData.map((M,P)=>c[P].binIndex===s&&m.hiddenBins[s]?null:M),v.update()}}},scales:{x:{ticks:{display:!1},afterFit:a=>a.height=50},y:{beginAtZero:!0,title:{display:!1,text:"PR Age (days)"}}},users:i};return{data:{labels:h,datasets:[g]},options:b}},[c,u]);return{data:y.data,options:y.options,isLoading:f,metrics:d,prDetails:t}}function K(r){const f=Math.ceil(r[0]),p=Math.floor(r[r.length-1]),e=S(r,t=>Math.floor(t)).reverse();if(e.length<2)return[{label:`Below ${f} days`,color:"",min:p,max:f}];if(e.length<3)return[{label:`Below ${Math.ceil(o(e[0].values))} days`,min:p,max:Math.ceil(o(e[0].values)),color:""},{label:`Above ${Math.floor(e[1].values[0])} days`,min:Math.floor(e[1].values[0]),max:f,color:""}];if(e.length===3)return[{label:`Below ${Math.ceil(o(e[0].values))} days`,min:p,max:Math.ceil(o(e[0].values)),color:""},{label:`Below ${Math.ceil(o(e[1].values))} days`,min:Math.floor(e[1].values[0]),max:Math.ceil(o(e[1].values)),color:""},{label:`Above ${Math.floor(e[2].values[0])} days`,min:Math.floor(e[2].values[0]),max:f,color:""}];const d=[{label:`Below ${Math.ceil(o(e[0].values))} days`,min:p,max:Math.ceil(o(e[0].values)),color:""},{label:`Above ${Math.floor(o(e,t=>t.values[0]))} days`,min:Math.floor(o(e,t=>t.values[0])),max:f,color:""}];if(e.length===4||e.length===5){const t=d[0];t.max=Math.ceil(o(e[1].values)),t.label=`Below ${t.max} days`}if(e.length===4)d.splice(1,0,{label:`Below ${Math.ceil(o(e[2].values))} days`,min:Math.floor(e[2].values[0]),max:Math.ceil(o(e[2].values)),color:""});else if(e.length===5)d.splice(1,0,{label:`${Math.floor(e[2].values[0])} to ${Math.ceil(o(e[3].values))} days`,min:Math.floor(e[2].values[0]),max:Math.ceil(o(e[3].values)),color:""});else{const t=e.length/3,c=d[0];c.max=Math.ceil(o(e[Math.ceil(t-1)].values)),c.label=`Below ${c.max} days`;const u=Math.ceil(t),y=Math.floor(t),i={label:"",min:Math.floor(e[u].values[0]),max:Math.ceil(o(e[u+y].values)),color:""};i.label=`${i.min} to ${i.max} days`,d.splice(1,0,i);const h=o(d);h.min=Math.floor(e[u+y+1].values[0]),h.label=`Above ${h.min} days`}return d}const Q=L.filter(r=>r.field!=="state"&&r.field!=="closed");function ee(){const{data:r,options:f,metrics:p,isLoading:e,prDetails:d}=J(),[t,c]=A.useState(null),u=({row:y})=>c(y);return n.jsxs("div",{children:[n.jsx(Z,{title:"Pull Request Aging"}),n.jsxs("div",{className:"flex flex-col gap-4",children:[n.jsx(z,{data:r,options:f,metrics:p,isLoading:e}),n.jsx(E,{isLoading:e,containerClassName:"max-h-[80vh]",columns:Q,rows:d,noRowsMessage:"No data found",totalRows:d.length,pagination:!1,onRowClick:u}),!!t&&n.jsx(U,{className:"mt-6",pr:t.pr,url:t.url})]})]})}export{ee as default};
