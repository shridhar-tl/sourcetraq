import{j as n,c as B,i as N,r as C,V as k,P as I,W as O,X as S,e as T,n as q,Y as o,Z as E}from"../index.DXRZs43y.js";import{S as U,g as L,T as F,b as W,a as Z}from"./PRActivityDetails-BjvBO3-E.js";import{C as A,S as D,a as _,b as G,c as H,u as J,J as V,U as X,P as Y}from"./chart-options-CQfSVkHI.js";function z({data:c,options:g,metrics:p,isLoading:e}){const{averagePRAge:d,contributorCount:t,maxPRAge:r,totalPRCount:m}=p||{};return n.jsxs("div",{className:B("bg-white dark:bg-gray-900 rounded-md px-4 pt-4 flex flex-col flex-1 w-full",{"shadow-lg":!N}),children:[n.jsx("div",{className:"flex justify-between items-center mb-4",children:n.jsx("h3",{className:"text-lg font-extrabold text-gray-600 dark:text-gray-200",children:"Open Pull Requests"})}),n.jsxs("div",{className:"flex flex-col md:flex-row gap-3 justify-around mb-3 w-full",children:[n.jsx(A,{isLoading:e,total:d,label:"Avg. Age",icon:D,iconProps:{fill:"#00c951"},textClassName:"text-green-700 dark:text-green-300"}),n.jsx(A,{isLoading:e,total:r,label:"Max Age",icon:D,iconProps:{fill:"#00c951"},textClassName:"text-green-700 dark:text-green-300"}),n.jsx(A,{isLoading:e,total:m,label:"Total Count",icon:U,iconProps:{fill:"#00c951"},textClassName:"text-green-700 dark:text-green-300"}),n.jsx(A,{isLoading:e,total:t,label:"Contributors",icon:_,iconProps:{fill:"#00c951"},textClassName:"text-green-700 dark:text-green-300"})]}),n.jsxs("div",{className:"w-full flex-1",children:[e&&n.jsx("div",{className:"pb-4 h-88",children:n.jsx(G,{count:15,order:"desc",legendsCount:4})}),!e&&!!c&&n.jsx(H,{data:c,options:g,type:"bar",width:"100%",height:370})]})]})}function K(){const{current:c,isLoading:g}=J(),p=(c==null?void 0:c.prList)||[],{openPRs:e,metrics:d,prDetails:t}=C.useMemo(()=>{const l=p.filter(i=>i.state==="OPEN"),x=L(l),f=k(x,i=>i.exactDaysOpen),v=I(x,i=>i.exactDaysOpen),a=O(x,i=>i.exactDaysOpen),s=S(l,i=>{var h,y;return(y=(h=i.author)==null?void 0:h.user)==null?void 0:y.name}),u={totalPRCount:l.length,contributorCount:s,averagePRAge:a,maxPRAge:v,minPRAge:f};return{openPRs:l,metrics:u,prDetails:T(x,i=>i.exactDaysOpen)}},[p]),{sortedPRs:r,bins:m}=C.useMemo(()=>{if(!(t!=null&&t.length))return{sortedPRs:[],bins:[]};const l=t.slice(0,20),x=l.map(v=>v.exactDaysOpen),f=Q(x).reverse();if(f.length){const v=f.length;f.forEach((a,s)=>{const u=Math.round(s/(v>1?v-1:1)*120);a.color=`hsl(${u}, 70%, 50%)`});for(const a of l)for(let s=0;s<f.length&&(a.binIndex=s,!(a.exactDaysOpen>=f[s].min));s++);}return{sortedPRs:l,bins:f}},[e]),M=C.useMemo(()=>{const l=r.map(a=>{var s;return(s=a.pr.author)==null?void 0:s.user}),x=l.map(a=>(a==null?void 0:a.displayName)||(a==null?void 0:a.name)||"Unknown"),f={label:"PR Age",originalData:r.map(a=>a.daysOpen),backgroundColor:r.map(a=>{var u;const s=a.binIndex;return((u=m[s])==null?void 0:u.color)||"gray"}),data:r.map(a=>a.daysOpen),prDetails:r.map(a=>a.pr),hiddenBins:Array(m.length).fill(!1)},v=V(a=>({...X(),plugins:{tooltip:{callbacks:{label:s=>{var y,b,P,R;const u=s.dataset,i=s.dataIndex,h=u.prDetails&&u.prDetails[i];if(h){const w=((b=(y=h.author)==null?void 0:y.user)==null?void 0:b.displayName)||((R=(P=h.author)==null?void 0:P.user)==null?void 0:R.name)||"Unknown",j=h.title||"",$=E(h.createdDate).toLocaleDateString();return[`Title: ${j}`,`Author: ${w}`,`Created: ${$}`,`Age: ${s.parsed.y} days`]}return""}}},legend:{labels:{generateLabels:s=>m.map((u,i)=>({text:u.label,fontColor:a,fillStyle:u.color,binIndex:i,datasetIndex:0}))},onClick:(s,u,i)=>{const h=u.binIndex,y=i.chart,b=y.data.datasets[0];b.hiddenBins=b.hiddenBins||Array(m.length).fill(!1),b.hiddenBins[h]=!b.hiddenBins[h],b.data=b.originalData.map((P,R)=>r[R].binIndex===h&&b.hiddenBins[h]?null:P),y.update()}}},scales:{x:{ticks:{display:!1},afterFit:s=>s.height=50},y:{beginAtZero:!0,title:{display:!1,text:"PR Age (days)"}}},users:l}));return{data:{labels:x,datasets:[f]},options:v}},[r,m]);return{data:M.data,options:M.options,isLoading:g,metrics:d,prDetails:t}}function Q(c){const g=Math.ceil(c[0]),p=Math.floor(c[c.length-1]),e=q(c,t=>Math.floor(t)).reverse();if(e.length<2)return[{label:`Below ${g} days`,color:"",min:p,max:g}];if(e.length<3)return[{label:`Below ${Math.ceil(o(e[0].values))} days`,min:p,max:Math.ceil(o(e[0].values)),color:""},{label:`Above ${Math.floor(e[1].values[0])} days`,min:Math.floor(e[1].values[0]),max:g,color:""}];if(e.length===3)return[{label:`Below ${Math.ceil(o(e[0].values))} days`,min:p,max:Math.ceil(o(e[0].values)),color:""},{label:`Below ${Math.ceil(o(e[1].values))} days`,min:Math.floor(e[1].values[0]),max:Math.ceil(o(e[1].values)),color:""},{label:`Above ${Math.floor(e[2].values[0])} days`,min:Math.floor(e[2].values[0]),max:g,color:""}];const d=[{label:`Below ${Math.ceil(o(e[0].values))} days`,min:p,max:Math.ceil(o(e[0].values)),color:""},{label:`Above ${Math.floor(o(e,t=>t.values[0]))} days`,min:Math.floor(o(e,t=>t.values[0])),max:g,color:""}];if(e.length===4||e.length===5){const t=d[0];t.max=Math.ceil(o(e[1].values)),t.label=`Below ${t.max} days`}if(e.length===4)d.splice(1,0,{label:`Below ${Math.ceil(o(e[2].values))} days`,min:Math.floor(e[2].values[0]),max:Math.ceil(o(e[2].values)),color:""});else if(e.length===5)d.splice(1,0,{label:`${Math.floor(e[2].values[0])} to ${Math.ceil(o(e[3].values))} days`,min:Math.floor(e[2].values[0]),max:Math.ceil(o(e[3].values)),color:""});else{const t=e.length/3,r=d[0];r.max=Math.ceil(o(e[Math.ceil(t-1)].values)),r.label=`Below ${r.max} days`;const m=Math.ceil(t),M=Math.floor(t),l={label:"",min:Math.floor(e[m].values[0]),max:Math.ceil(o(e[m+M].values)),color:""};l.label=`${l.min} to ${l.max} days`,d.splice(1,0,l);const x=o(d);x.min=Math.floor(e[m+M+1].values[0]),x.label=`Above ${x.min} days`}return d}const ee=W.filter(c=>c.field!=="state"&&c.field!=="closed");function le({forPrint:c}){const{data:g,options:p,metrics:e,isLoading:d,prDetails:t}=K(),[r,m]=C.useState(null),M=({row:l})=>m(l);return n.jsxs("div",{children:[!c&&n.jsx(Y,{title:"Pull Request Aging"}),n.jsxs("div",{className:"flex flex-col gap-4",children:[n.jsx(z,{data:g,options:p,metrics:e,isLoading:d}),n.jsx(F,{isLoading:d,containerClassName:"max-h-[80vh]",columns:ee,rows:t,noRowsMessage:"No data found",totalRows:t.length,pagination:!1,onRowClick:M}),!!r&&n.jsx(Z,{className:"mt-6",pr:r.pr,url:r.url})]})]})}export{le as default};
