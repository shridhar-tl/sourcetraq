var L=Object.defineProperty;var S=(e,s,r)=>s in e?L(e,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[s]=r;var C=(e,s,r)=>S(e,typeof s!="symbol"?s+"":s,r);import{r as f,j as t,c as p,L as F,d as O,h as W,s as B,e as R,i as q,u as I,k,l as z,m as P,n as $,R as H}from"../index.B8kfND-w.js";import{t as A,u as M,f as U,P as G}from"./chart-options-DM8ui2XP.js";import{P as V,R as _,a as K,b as J}from"./ReviewerStatsChart-CJl-EFEE.js";import{P as Q,p as X,e as Y,a as Z,T as ee}from"./PRActivityDetails-FPY38KXY.js";import{I as T}from"./Image-DMgGWcZf.js";import{c as te}from"./chart-helpers-B-8f81-o.js";const se=e=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"{2} ",stroke:"currentColor",className:"size-4",...e},f.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.5 12h-15"})),re=e=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"{2} ",stroke:"currentColor",...e},f.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"}));function ae({height:e,tabs:s,className:r}){const[c,u]=f.useState(window.innerWidth),[a,o]=f.useState(s.map(n=>n.isOpen));f.useEffect(()=>{const n=()=>u(window.innerWidth);return n(),window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[]);const i=f.useCallback(n=>{a.filter(Boolean).length===1&&a[n]||o(m=>m.map((h,w)=>w===n?!h:h))},[a]),l=a.filter(Boolean).length,x=n=>({maxWidth:n&&c>=1024?le(l,a,s.length):void 0});return t.jsx("div",{className:p("flex flex-col lg:flex-row w-full h-full max-w-full",r),style:{minHeight:`${e}px`},children:s.map((n,d)=>{const m=a[d],h=x(m);return t.jsxs("div",{style:h,className:p("relative transition-all duration-300 bg-white",{"flex-grow border-white":m,"flex-none w-full lg:w-10 hover:bg-[#ecf2f8] px-2 lg:px-0 border border-gray-200":!m,"mt-3 ms-0 lg:mt-0 lg:ms-3":d>0&&m&&a[d-1],"mt-2 lg:mt-0":!m&&d>0&&a[d-1],"mb-2 lg:mb-0":!m&&a[d+1]}),children:[!m&&t.jsxs("div",{className:"flex lg:flex-col w-full lg:w-auto lg:h-full inset-0 cursor-pointer py-2",onClick:()=>i(d),children:[t.jsx("div",{children:t.jsx(re,{className:"size-5 mx-auto mb-1"})}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsx("span",{className:"text-base lg:transform lg:-rotate-90 whitespace-nowrap text-center",children:n.label})})]}),m&&t.jsxs(t.Fragment,{children:[l>1&&t.jsx("div",{className:"absolute -top-3 right-2 cursor-pointer z-10",onClick:()=>i(d),children:t.jsx("div",{className:"bg-[#f1f5f9] hover:bg-[#e2ecf7] rounded-full p-1 shadow",children:t.jsx(se,{className:"size-4"})})}),t.jsx("div",{className:"h-full overflow-hidden",children:n.render({index:d,isOpen:m,totalOpen:l,maxWidth:h.maxWidth})})]})]},n.id||d)})})}function le(e,s,r){const c=12*s.reduce((o,i,l)=>i&&l&&s[l-1]?o+1:0,0),u=parseFloat((((r-e)*40+c)/e).toFixed(2));return`calc(${parseFloat((100/e).toFixed(2))}% - ${u}px)`}class ne{constructor(s){C(this,"tasks",[]);C(this,"currentCount",0);this.maxConcurrency=s}async acquire(){return this.currentCount<this.maxConcurrency?(this.currentCount++,this.release.bind(this)):new Promise(s=>{this.tasks.push(()=>{this.currentCount++,s(this.release.bind(this))})})}release(){if(this.currentCount--,this.tasks.length>0){const s=this.tasks.shift();s&&s()}}}const ie=({item:e,fetchActivity:s,maxDays:r,activityColors:c,statusColor:u,tooltipRenderer:a,semaphore:o,onItemClick:i})=>{var h,w,j;const l=f.useRef(null),[x,n]=f.useState(null),d=A(100/e.days)+"%";f.useEffect(()=>{if(x)return;const g=new IntersectionObserver(v=>{v.forEach(async y=>{if(y.isIntersecting&&!x){const b=await o.acquire();try{const N=await s(e);n(N),l.current&&g.observe(l.current)}finally{b()}}})},{rootMargin:"100px"});return l.current&&g.observe(l.current),()=>{l.current&&g.unobserve(l.current)}},[x,s,e.id,o]);const m=Array.from({length:e.days});return t.jsxs("div",{ref:l,className:"flex items-center justify-between border-b border-gray-200 h-19 py-1 ps-2 gap-2",children:[t.jsxs("div",{className:p("w-10 min-w-10",{"flex flex-col h-full justify-around":!!e.flagColor,"h-10":!e.flagColor}),children:[t.jsx(T,{src:e.user.avatar,displayName:e.user.displayName,className:"rounded-full"}),!!e.flagColor&&t.jsx("div",{className:"w-full h-3 rounded",style:{backgroundColor:e.flagColor},title:e.flagMessage})]}),t.jsxs("div",{className:"flex flex-1 flex-col gap-2 cursor-pointer max-w-[calc(100%-50px)]",onClick:i?()=>i(e):void 0,children:[t.jsxs("div",{className:"flex items-center justify-between px-1 gap-2 w-full",children:[t.jsxs("div",{className:"flex-1 text-xs overflow-hidden truncate",children:[t.jsxs(F,{href:e.url,children:["#",e.id]})," - ",e.title]}),t.jsxs("div",{className:"flex-none flex items-center gap-2",children:[t.jsx("div",{className:"text-xs text-gray-500 whitespace-nowrap",children:O(e.startDate,e.endDate)}),t.jsxs("div",{className:"flex flex-grow gap-1",children:[(h=e.participants)==null?void 0:h.slice(0,3).map((g,v)=>t.jsx(T,{src:g.user.avatar,displayName:g.user.displayName,className:"rounded-full",size:"xs"},v)),((w=e.participants)==null?void 0:w.length)>3&&t.jsxs("div",{className:"flex flex-column items-center justify-center size-6 text-[11px] rounded-full bg-[#9cc8f3]",children:["+",((j=e.participants)==null?void 0:j.length)-3]})]}),t.jsx(Q,{pr:e.pr,state:e.state})]})]}),t.jsx("div",{className:"flex bg-blue-300 border-r-5 border-r-blue-300 h-8 rounded-e-md",style:{width:`${Math.min(100,A(e.days*100/r))}%`,borderRightColor:u[e.state]},children:m.map((g,v)=>{const y=(x==null?void 0:x[v])||[];return t.jsx("div",{style:{width:d},className:"flex flex-col",onMouseEnter:a?b=>B(b,a(e,v,y)):void 0,onMouseLeave:a?()=>W():void 0,children:y!=null&&y.length?y.map((b,N)=>t.jsx("div",{className:"flex-1",style:{backgroundColor:c[b.type]||"#"+Math.floor(Math.random()*16777215).toString(16)}},N)):t.jsx("div",{className:"flex-1"})},v)})})]})]})},oe=({maxDays:e})=>t.jsxs("div",{className:"flex border-t border-gray-300 ps-2 pe-1.5 py-1 font-semibold text-xs",children:[t.jsx("span",{className:"mr-3.5",children:"Days:"}),Array.from({length:e}).map((s,r)=>t.jsx("div",{className:"flex-1",children:t.jsx("span",{className:" text-gray-600",children:r})},r)),t.jsx("div",{className:"flex-none pe-2",children:t.jsx("span",{className:"text-gray-600",children:e})})]}),ce=({height:e=400,items:s,fetchActivity:r,activityColors:c={},statusColor:u={},tooltipRenderer:a,semaphoreConcurrency:o=3,onItemClick:i})=>{const l=f.useMemo(()=>Math.floor(s.reduce((n,d)=>Math.max(n,d.days),0)),[s]),x=f.useMemo(()=>new ne(o),[o]);return t.jsxs("div",{className:"w-full max-h-full",children:[t.jsx("div",{className:"flex flex-col overflow-y-auto overflow-x-hidden w-full",style:{height:e-23},children:s.map(n=>t.jsx(ie,{item:n,fetchActivity:r,maxDays:l,activityColors:c,statusColor:u,tooltipRenderer:a,semaphore:x,onItemClick:i},n.id))}),t.jsx(oe,{maxDays:l})]})};function de(){const{current:e,isLoading:s}=M(),r=(e==null?void 0:e.prList)||[],c=new Date,u=R(r.map(a=>{var g,v,y;const{id:o,closedDate:i,createdDate:l,reviewers:x,state:n,title:d,author:{user:m}={},description:h}=a,w=q(i||c,l),j=R(x.map(b=>({user:b.user,done:b.approved})),b=>b.done?1:0);if(!(w<1&&(n==="OPEN"||n==="MERGED")))return{id:o,user:m,participants:j,flagColor:Y(h),flagMessage:X,title:d,state:n,pr:a,startDate:l,endDate:i,days:w,url:(y=(v=(g=a.links)==null?void 0:g.self)==null?void 0:v[0])==null?void 0:y.href}}).filter(Boolean),a=>a.days);return{isLoading:s,prDetails:u}}const E={APPROVED:"#28a745",RESCOPED:"#f3ae2f",COMMENTED:"#6666f1",MERGED:"purple",OTHERS:"gray",UNAPPROVED:"#f56f76"},me={MERGED:"#00c951",DECLINED:"#fb2c36"},ue=(e,s,r)=>t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("div",{className:"truncate",children:t.jsxs("strong",{children:["#",e.id," - ",e.title]})}),t.jsxs("strong",{children:["Day ",s+1," Activities:"]}),t.jsx("div",{children:r!=null&&r.length?r.map(c=>`${c.type}: ${c.count}`).join(", "):"(Idle)"})]});function fe(e,s){const r=s.createdDate;return P(e,c=>$(c.createdDate,r)).reduce((c,u)=>(c[u.key]=P(u.values,a=>E[a.action]?a.action:"OTHERS").map(a=>({type:a.key,count:a.values.length,raw:a.values})),c),{})}function xe(){const{isLoading:e,prDetails:s}=de(),[r,c]=I(U(o=>{var i,l;return[(i=o.project)==null?void 0:i.key,(l=o.repository)==null?void 0:l.slug]})),u=o=>k(t.jsx(Z,{pr:o.pr,url:o.url}),{occupy:!0}),a=async o=>{const i=o.pr;if(!i.activities){const{$repository:l}=z("RepositoryService");i.activities=await l.getPullRequestActivity(r,c,o.id)}return fe(i.activities,i)};return t.jsxs("div",{className:"bg-white shadow-lg rounded-md pt-4 flex flex-col w-full",children:[t.jsxs("div",{className:"flex flex-wrap justify-between items-center mb-4 px-4 gap-3",children:[t.jsx("h3",{className:"whitespace-nowrap text-lg font-extrabold text-gray-600",children:"Day wise Activities"}),t.jsxs("div",{className:"flex flex-nowrap gap-2 text-[11px]",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[#28a745] inline-block mr-1"})," Approved"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[#6666f1] inline-block mr-1"})," Comment"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[#f3ae2f] inline-block mr-1"})," Commit"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[purple] inline-block mr-1"})," Merge"]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-5 h-3 bg-[gray] inline-block mr-1"})," Others"]})]})]}),t.jsx(ce,{isLoading:e,height:457,items:s,fetchActivity:a,activityColors:E,statusColor:me,tooltipRenderer:ue,semaphoreConcurrency:3,onItemClick:u})]})}function he({field:e,className:s,onChange:r,...c}){const u=H.useCallback(a=>r==null?void 0:r(a.target.value,e),[e,r]);return t.jsx("input",{className:p("px-2 h-9 bg-white border border-gray-200 rounded",s),...c,onChange:u})}function pe(e){const{current:s,previous:r,isLoading:c,settings:u}=M(),a=s==null?void 0:s.contributions,o=r==null?void 0:r.contributions,i=f.useMemo(()=>te(a,o),[a,o]),l=(e==null?void 0:e.toLowerCase())||"",x=f.useMemo(()=>l?i.filter(n=>{const{displayName:d,name:m,emailAddress:h}=n.user;return(d==null?void 0:d.toLowerCase().includes(l))||(m==null?void 0:m.toLowerCase().includes(l))||(h==null?void 0:h.toLowerCase().includes(l))}):i,[i,l]);return{isLoading:c,analytics:x,settings:u}}const D=[{field:"user.displayName",title:"Author Name",template:e=>{var s,r;return((s=e.user)==null?void 0:s.displayName)||((r=e.user)==null?void 0:r.name)},headerClassName:p("text-left")},{field:"user.emailAddress",title:"Email",hideBelow:"3xl",cellClassName:p("border-e border-gray-300"),headerClassName:p("border-e border-gray-300 text-left")},{field:"totalCommits",sortable:!0,title:"Total Commits",helpText:"Total number of commits by the user during this period",cellClassName:p("border-e border-gray-300 text-center"),headerClassName:p("border-e border-gray-300 text-center"),hideBelow:"2xl",template:e=>t.jsxs(t.Fragment,{children:[e.totalCommits," ",t.jsxs("span",{className:p("text-sm",{"text-green-600":e.commitDelta.diff>0,"text-red-600":e.commitDelta.diff<0}),children:["(",e.commitDelta.diff>=0?"+":"",e.commitDelta.diff," / ",e.commitDelta.percent,"%)"]})]})},{field:"totalPRs",sortable:!0,title:"PRs",helpText:"Total number of PR's raised by the user during this period",cellClassName:"text-center",headerClassName:"text-center",template:e=>t.jsxs(t.Fragment,{children:[e.totalPRs,t.jsxs("span",{className:p("text-sm ps-1.5 hidden xl:inline-block",{"text-green-600":e.prDelta.diff>0,"text-red-600":e.prDelta.diff<0}),children:["(",e.prDelta.diff>=0?"+":"",e.prDelta.diff," / ",e.prDelta.percent,"%)"]})]})},{field:"mergedPRs",title:"Merged",sortable:!0,helpText:"Total number of PR's raised by the user during this period is merged as of now",cellClassName:"text-center",headerClassName:"text-center"},{field:"declinedPRs",sortable:!0,title:"Declined",helpText:"Total number of PR's raised by the user during this period is declined",cellClassName:"text-center",headerClassName:"text-center",template:e=>!!e.declinedPRs&&t.jsxs(t.Fragment,{children:[e.declinedPRs,t.jsxs("span",{className:p("text-sm ps-1.5 hidden xl:inline-block",{"text-green-600":e.declinedDelta.diff<0,"text-red-600":e.declinedDelta.diff>=0}),children:["(",e.declinedDelta.diff>=0?"+":"",!!e.declinedDelta.diff&&t.jsxs(t.Fragment,{children:[e.declinedDelta.diff," / ",e.declinedDelta.percent,"%)"]})]})]})},{field:"avgPROpenDays",sortable:!0,title:"Age",helpText:"Average number of days the PR was open before either it is merged or declined",cellClassName:"text-center",headerClassName:"text-center",template:e=>e.avgPROpenDays>.5?e.avgPROpenDays:""},{field:"avgDaysFirstCommitToPR",sortable:!0,title:"Lag",helpText:"Average number of days it took for the user to raise PR after the first commit was created",cellClassName:"text-center",headerClassName:"text-center",template:e=>e.avgDaysFirstCommitToPR>.5?e.avgDaysFirstCommitToPR:""},{field:"avgDaysPRToMerge",sortable:!0,title:"Merge",helpText:"Average number of days it took for the user to merge the PR",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgDaysPRToApproval",sortable:!0,title:"Approval Lag",helpText:"Average number of days it took to get the Approval",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgReviewers",sortable:!0,title:"Reviewers",helpText:"Average number of reviewers added to each PR",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgReviewersApproved",sortable:!0,title:"Approvals",helpText:"Average number of reviewers approving the PR",cellClassName:"text-center",headerClassName:"text-center"},{field:"avgComments",sortable:!0,title:"Comments",helpText:"Average number of comments in the PR. This includes responses as well",cellClassName:"text-center",headerClassName:"text-center",template:e=>t.jsxs(t.Fragment,{children:[e.avgComments,(e.commentDelta.diff>=1||e.commentDelta.diff<=-1)&&t.jsxs("span",{className:p("text-sm ps-1.5 hidden xl:inline-block",{"text-green-600":e.commentDelta.diff<0,"text-red-600":e.commentDelta.diff>=0}),children:["(",e.commentDelta.diff>=0?"+":"",e.commentDelta.diff," / ",Math.round(e.commentDelta.percent),"%)"]})]})},{field:"avgDaysFirstActivity",sortable:!0,title:"Activity Lag",helpText:"Average number of days it took for first activity to happen in the PR.",cellClassName:"text-center",headerClassName:"text-center"}],ge={totalCommits:"includeCommits",avgDaysFirstCommitToPR:"includePRCommitMetrics",avgDaysFirstActivity:"includePRActivity",avgComments:"includePRActivity",avgDaysPRToApproval:"includePRActivity"},ve=D.find(e=>e.field==="totalPRs");function ye(){const[e,s]=f.useState(""),{isLoading:r,analytics:c,settings:u}=pe(e),a=({row:n})=>k(t.jsx(V,{username:n.user.name}),{occupy:!0}),{includeCommits:o,includePRCommitMetrics:i,includePRActivity:l}=u||{},x=f.useMemo(()=>{if(o&&i&&l)return D;const n={includeCommits:o,includePRCommitMetrics:i,includePRActivity:l};return D.filter(d=>{const m=ge[d.field];return m?n[m]!==!1:!0})},[o,i,l]);return t.jsxs("div",{className:"my-6",children:[t.jsxs("div",{className:"flex justify justify-between",children:[t.jsx("h3",{className:"text-base font-semibold mb-4",children:"Author Wise Metrics"}),t.jsx(he,{placeholder:"Search for users",onChange:s,className:"w-50"})]}),t.jsx(ee,{isLoading:r,expectedRows:5,columns:x,rows:c,sortColumn:ve,sortAsc:!1,noRowsMessage:"No data found",totalRows:c.length,pagination:!1,onRowClick:a})]})}const be=[{id:"resolution-time-distribution",label:"Resolution Time Distribution",isOpen:!1,render:({maxWidth:e,totalOpen:s})=>t.jsx(_,{maxWidth:e,totalOpen:s})},{id:"reviewer-stats-chart",label:"Reviewer Metrics",isOpen:!0,render:({maxWidth:e,totalOpen:s})=>t.jsx(K,{maxWidth:e,totalOpen:s})},{id:"pull-request-chart",label:"Pull Request Metrics",isOpen:!0,render:({maxWidth:e,totalOpen:s})=>t.jsx(J,{maxWidth:e,totalOpen:s})},{id:"pull-request-cycle-time-chart",label:"Cycle Time Analysis",isOpen:!1,render:()=>t.jsx(xe,{})}];function Ae(){return t.jsxs("div",{children:[t.jsx(G,{title:"Pull Request Analysis"}),t.jsx(ae,{tabs:be,height:520}),t.jsx(ye,{})]})}export{Ae as default};
